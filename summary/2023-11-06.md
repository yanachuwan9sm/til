# AppRouter ã«ãŠã‘ã‚‹ 4 å¤§ Cache ã‚’ã»ã‚“ã®å°‘ã—ç†è§£ã™ã‚‹

## 4 å¤§ cache

| Mechanism                          | What                                                             | Where  | Duration                           |
| ---------------------------------- | ---------------------------------------------------------------- | ------ | ---------------------------------- |
| React Cacheï¼ˆRequest Memoizationï¼‰ | é‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ’é™¤ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’æ¸›ã‚‰ã™                     | Server | ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯                       |
| Data Cache                         | **Fetch å˜ä½**ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹                           | Server | æ°¸ç¶šçš„ï¼ˆå†æ¤œè¨¼å¯èƒ½ï¼‰               |
| Full Route Cache                   | **é™çš„ãƒ«ãƒ¼ãƒˆï¼ˆHTMLã€RSC ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä¸¸ã”ã¨ï¼‰å˜ä½**ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ | Server | æ°¸ç¶šçš„ï¼ˆå†æ¤œè¨¼å¯èƒ½ï¼‰               |
| Router Cache                       | `next/link` ã® `prefetch` ã—ãŸçµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹               | Client | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ or æ™‚é–“ãƒ™ãƒ¼ã‚¹ |

## React Cacheï¼ˆRequest Memoizationï¼‰

**1 å›ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ä¸­ã§åŒã˜ URL ã¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒã¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å†åˆ©ç”¨ã™ã‚‹**ã¨ã„ã†ã‚‚ã®ã€‚
ãã®ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ä¸Šã§ã¯åŒã˜ API ã‚’å„æ‰€ã§å‘¼ã¶ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã ã‘ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ•°ã¯ä¸€å›ã ã‘ã«ãªã‚Šã€ãã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä½¿ã„å›ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

Next.js ã® fetch é–¢æ•° ã‚’åˆ©ç”¨ã™ã‚‹ã ã‘ã§ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã¾ãŸã€fetch é–¢æ•° etc ã‚’ä½¿ãˆãªã„å ´åˆã¯ [React Cache ã‚’ç›´æ¥ä½¿ç”¨ã™ã‚‹](https://nextjs.org/docs/app/building-your-application/caching#react-cache-function)ã“ã¨ã§ DB ã‚¢ã‚¯ã‚»ã‚¹ã‚„ GraphQL ã‚„ã‚‰ã§ã‚‚å®Ÿç¾ã§ãã‚‹ã€‚
ã¾ãŸã€fetch é–¢æ•°ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ç”»é¢æç”»ãŒçµ‚ã‚ã‚‹ã¨ç ´æ£„ã•ã‚Œã‚‹ã€‚ï¼ˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã”ã¨ã«è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç ´æ£„ã™ã‚‹ï¼‰

![](assets/20231106180802.png)

## Data Cache

Next.js ã® fetch é–¢æ•°ç­‰ã‚’ç”¨ã„ã¦å‡ºã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å¯¾ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã“ã¨ã‚’æŒ‡ã™ã€‚
ã¤ã¾ã‚Šã€fetch ã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸçµæœã¯ Data Cache ã«ä¿å­˜ã•ã‚Œã€ä»¥é™åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ Data Cache ã‹ã‚‰è¿”ã•ã‚Œã‚‹ã€‚
ğŸ‘‰ ã‚ªãƒªã‚¸ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã‚’æ¸›ã‚‰ã™ã“ã¨ã«ã¤ãªãŒã‚‹

**æ˜ç¤ºçš„ã«è¨­å®šã—ãªã‘ã‚Œã°ã“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯æ®‹ã‚Šç¶šã‘ã‚‹**ï¼ˆãƒã‚°ã®æ¸©åºŠï¼‰ãŸã‚ã€ä¸€å®šæœŸé–“ã‚„ç‰¹å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç ´æ£„ã™ã‚‹ãŸã‚ã«ã€
`fetch` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆ`Revalidation` ã‚„ `Opt out` ï¼‰ãªã©ã«ã‚ˆã‚‹å†æ¤œè¨¼ã‚„ã‚ªãƒ—ãƒˆã‚¢ã‚¦ãƒˆãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚

```tsx
// 1æ™‚é–“ã§RefalidationãŒè¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸
fetch('https://...', { next: { revalidate: 3600 } });

fetch(`https://...`, { next: { tags: ['a', 'b', 'c'] } }); // ã“ã‚Œã«ã‚ˆã£ã¦å¾—ã‚‰ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« a, b, c 3ã¤ã®ã‚¿ã‚°ã‚’ä»˜ä¸
revalidateTag('a'); // a ã¨ã„ã†ã‚¿ã‚°ãŒã¤ã„ã¦ã„ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’Revalidate (ã“ã‚Œã§ä¸Šè¨˜ã®fetché–¢æ•°ã§å¾—ã‚‰ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç ´æ£„ã•ã‚Œã‚‹)

// Opt outï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆã•ã›ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
// æ³¨æ„ : ã‚ã‚‹RouteãŒOpt outã™ã‚‹ã‚ˆã†è¨­å®šã•ã‚Œã¦ã„ã‚‹fetché–¢æ•°ã‚’å«ã‚€å ´åˆã€ãã®Routeã§ã¯ Full Route Cacheã‚‚Opt outã•ã‚Œã‚‹
fetch(`https://...`, { cache: 'no-store' });

//Route Segment Config ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
// ç‰¹å®šã®ãƒ«ãƒ¼ãƒˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹ã«ã™ã‚‹ï¼ˆã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å«ã‚€ã€ãƒ«ãƒ¼ãƒˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†…ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å½±éŸ¿ï¼‰
export const dynamic = 'force-dynamic';
```

![](assets/20231106181156.png)

## Full Route Cache

**ãƒ“ãƒ«ãƒ‰ã¾ãŸã¯å†æ¤œè¨¼æ™‚ã«é™çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆï¼ˆRouteï¼‰ã«å¯¾ã—ã¦ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ RSC Payload ã¨ HTML ã‚’ç”Ÿæˆã—ã€ãã‚Œã‚‰ã‚’ Full Route Cache ã¨ã—ã¦ä¿å­˜**ã™ã‚‹ã€‚ï¼ˆå‹•çš„ãƒ«ãƒ¼ãƒˆã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã§ã€Full Route Cache ã¸ã®ä¿å­˜ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ã€‚ï¼‰

RSC Payload ã¨ HTML ã‚’ä¸¸ã”ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ğŸ‘‰ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§é™çš„ãƒ«ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã«ã¯æ—¢ã« Data Cache ã‚„ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯å®Œäº†ã—ã¦ã„ã‚‹ã€‚

ã¾ãŸ Data Cache ã¨åŒæ§˜ã«æ°¸ç¶šçš„ã§å†æ¤œè¨¼ã«ã‚ˆã‚Šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç ´æ£„ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŒã€**Data Cache ã¨ã¯ç•°ãªã‚Šå†ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã‚ˆã£ã¦ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ç ´æ£„ã•ã‚Œã‚‹ã€‚**

## Router Cache

**App Router ã® navigation ï¼ˆ`next/navigation`ï¼‰ã¯ `prefetch` ã«ã‚ˆã‚Šãƒ«ãƒ¼ãƒˆã‚’äº‹å‰ã«å–å¾—ã—ã€ãã®çµæœï¼ˆè¨ªå•æ¸ˆã¿ã®ãƒ«ãƒ¼ãƒˆï¼‰ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§é™çš„/å‹•çš„ãƒ«ãƒ¼ãƒˆå•ã‚ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥**ã—ã¦ã„ã‚‹ã€‚**ã“ã® cache ãŒ Router Cacheï¼ˆãŸã ã® prefetch ã® cacheï¼‰**ã€‚

ã“ã‚Œã«ã‚ˆã‚Šãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰/ãƒãƒƒã‚¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹é«˜é€Ÿãªç”»é¢é·ç§»ã‚’å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã® UX å‘ä¸Šã«ã¤ãªãŒã‚‹ã€‚

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ã¯ã‚ã‚‹ãŒã€é·ç§»æ™‚ã«å¿…ãšé€šã‚‹å‡¦ç†ã§ã‚ã‚‹ã“ã¨ã‚’æ³¨æ„ã™ã‚‹ï¼ˆãªã‘ã‚Œã°é·ç§»æ™‚ã« fetch ã—ã¦ cache ã«æ ¼ç´ã—ã¦ã‚‹ã‚ˆï¼‰

**Router Cache ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã§æœ‰åŠ¹ãªã®ã§ã€ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç ´æ£„ã•ã‚Œã‚‹ã€‚ã¾ãŸã€æ™‚é–“çµŒéï¼ˆ30 ç§’ã‚‚ã—ãã¯ 5 åˆ†é–“ ï¼‰ã«ã‚ˆã£ã¦ã‚‚ç ´æ£„ã•ã‚Œã‚‹ã€‚**

![](assets/20231106190920.png)

### æ™‚é–“çµŒéã«ãŠã‘ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç ´æ£„

Router Cache ã® æ™‚é–“çµŒéã«ãŠã‘ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç ´æ£„ã¯ã€å–å¾—æ™‚é–“ã¨åˆ©ç”¨æ™‚é–“ã«ã‚ˆã£ã¦è¤‡é›‘ã«åˆ†å²ãŒã‚ã‚‹ã€‚

#### cache ã®ç¨®é¡

- `auto` - ãƒšãƒ¼ã‚¸ãŒå‹•çš„ãªå ´åˆã¯ã€ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’éƒ¨åˆ†çš„ã«ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã—ã€é™çš„ãªå ´åˆã¯ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã—ã¾ã™ã€‚
- `full` - ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã™ã‚‹ã€‚
- `temporary` - next/link ã§ prefetch={false}ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã¨ã or ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ãƒ«ãƒ¼ãƒˆã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨ãã«ä½¿ç”¨ã•ã‚Œã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€‚

#### cache ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

- `fresh`, `reusable` ğŸ‘‰ prefetch/fetch ã‚’å†ç™ºè¡Œã›ãšã€cache ã‚’å†åˆ©ç”¨ã™ã‚‹
- `stale` ğŸ‘‰ Dynamic Rendering éƒ¨åˆ†ã ã‘é·ç§»æ™‚ã«å† fetch ã‚’è¡Œã†
- `expired` ğŸ‘‰ prefetch/fetch ã‚’å†ç™ºè¡Œã™ã‚‹

| æ™‚é–“åˆ¤å®š / cache ã®ç¨®é¡           | auto     | full     | temporary |
| :-------------------------------- | :------- | :------- | :-------- |
| prefetch/fetch ã‹ã‚‰ **30 ç§’ä»¥å†…** | fresh    | fresh    | fresh     |
| lastUsed ã‹ã‚‰ 30 ç§’ä»¥å†…           | reusable | reusable | reusable  |
| prefetch/fetch ã‹ã‚‰ 30 ç§’~5 åˆ†    | stale    | reusable | expired   |
| prefetch/fetch ã‹ã‚‰ 5 åˆ†ä»¥é™      | expired  | expired  | expired   |

ã“ã®è¡¨ã‹ã‚‰ã€åŒã˜ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§ã®é·ç§»ã«é–¢ã—ã¦ã¯ã€ä½•ã‹ã—ã‚‰ã®å·¥å¤«ã‚’éƒ½åº¦è¡Œã‚ãªã‘ã‚Œã°æœ€ä½ã§ã‚‚ 30 ç§’é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå€¤ãŒè¡¨ç¤ºã•ã‚Œç¶šã‘ã¦ã—ã¾ã†ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚

### Router Cache ã®å•é¡Œç‚¹

- Invalidate (å¤±åŠ¹ã•ã›ã‚‹) ã“ã¨ã¯å‡ºæ¥ã¦ã‚‚ã€Opt out (ãã‚‚ãã‚‚ç”Ÿæˆã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨) ã¯ã§ããªã„ã€‚ -> `router.refresh()`ã§å…¨ã¦ã® cache ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã“ã¨ã¯å¯èƒ½ã§ã¯ã‚ã‚‹ã€‚
- åŒã˜ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§ã®é·ç§»ã«é–¢ã—ã¦ã¯ã€ä½•ã‹ã—ã‚‰ã®å·¥å¤«ã‚’éƒ½åº¦è¡Œã‚ãªã‘ã‚Œã°æœ€ä½ã§ã‚‚ 30 ç§’é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå€¤ãŒè¡¨ç¤ºã•ã‚Œç¶šã‘ã¦ã—ã¾ã†ã€‚

## å‚è€ƒæ–‡çŒ®

[Next.js: App Router: Building Your Application: Caching in Next.js](https://nextjs.org/docs/app/building-your-application/caching)

[Next.js: App Router: API Reference: Functions: fetch](https://nextjs.org/docs/app/api-reference/functions/fetch)

[Next.js App Router çŸ¥ã‚‰ã‚Œã–ã‚‹ Client-side Cache ã®ä»•æ§˜](https://zenn.dev/akfm/articles/next-app-router-client-cache)

[Next.js ã® App Router ãŒæä¾›ã™ã‚‹ 4 ã¤ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ - SO Technologies é–‹ç™ºè€…ãƒ–ãƒ­ã‚°](https://developer.so-tech.co.jp/entry/2023/11/06/121802)
[Next.js ã® 4 ã¤ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥](https://zenn.dev/frontendflat/articles/nextjs-cache)
