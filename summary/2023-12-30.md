# TCP の 3way ハンドシェイクをさらっと理解する

## 結論

TCP の 3 ウェイハンドシェイク（**SYN→SYN/ACK→ACK**）を行い、TCP セッションを確立している。

## TCP 通信を行うとは？

**「TCP 接続を確立する」＝「信頼性の高い通信を始める」ということ。**

通信の際の両端で準備が完了していることを示す必要があり、通信の信頼を保つにために必要な要件は以下の３つ。

- パケットの到達が確認できるか
- パケットの並び順が順序どおりか
- **どれくらいパケットを一度に送っても大丈夫かなどの輻輳制御と呼ばれるキャパシティの管理**

上記の中でも特に、**パケットの到達確認とパケットの並び順が順序通りになるかを示すのが接続の確立時に求められる**。

👉 これを実現するために、3way ハンドシェイク が必要となる。

## 1way や 2way ではアカンのか？

以下の通り、アカンです。

### 2way ハンドシェイク

サーバからクライアントに声が聞こえているのか ≒ 到達が確認できているかをサーバが確認するというプロセスがない。

```
クライアント: 「もしもし〜聞こえる？(SYN)」
サーバ:「聞こえるで。俺の声も聞こえてる？(SYN-ACK)」
クライアント：「明日10時にxxxに集合な〜ほなまた。」
```

### 1way ハンドシェイク

これだとクライアントの声がサーバに聞こえてるかは確認できていません

```
クライアント: 「もしもし〜聞こえる？(SYN)」
クライアント：「明日10時にxxxに集合な〜ほなまた。」
```

## 3way ハンドシェイクのポイント

3way ハンドシェイクにおいては、確認するポイントが 3 つある。

![](assets/20231212233347.png)

- クライアントからサーバに対して接続できてるかを確認すること
- サーバからクライアントに対して接続できてるかを確認すること
- 到達した情報が順序通りであること

① 確認するためにクライアントからサーバに対して同期信号(SYN)と順序確認のための番号(シーケンス番号)を一緒に送ります。

② サーバは同期信号(SYN)と順序番号(シーケンス番号)を見て、
同期信号と一緒に確認信号を送ります(SYN-ACK)。

③ 同期確認を受け取ったら、クライアントも確認を返します(ACK)

### 3way ハンドシェイク

```
クライアント: 「もしもし〜聞こえる？(SYN)」
サーバ:「聞こえるで。俺の声も聞こえてる？(SYN-ACK)」
クライアント:「バチバチ聞こえてるで(ACK)」
クライアント：「明日10時にxxxに集合な〜ほなまた。」
```

## 3way ハンドシェイクの代案・新しい検討

これまではネットワークの信頼性を担保しようとすると 3 way ハンドシェイクが必要だったけど、
他の手段について、以下のようないくつか新しい方法の検討も進められている。

- TCP Fast Open
- QUIC などの UDP をベースにした方法

### TCP Fast Open

一度接続が確立した後であれば、3 way ハンドシェイクを飛ばしてデータを送信する方法。
ただし、TCP Fast Open は普及率がそこまで高くないのと、過去に以下のような問題があった。

> TCP Fast Open の闇と、Kernel の緩和コミット - ASnoKaze blog
> TCP Fast Open TCP Fast Open と呼ばれる技術があり、RFC 7413 として標準化されている。この TCP Fast Open を使うと、一度コネクションを貼った相手とは、TCP の 3 ウェイハンドシェイク中にデータを送受信できるようになる。クライアントから SYN とともにデータを送信することで、実際にデータを送受信開始するまでの待ち時間が短縮できる。Linux ではすでにクライアント/サーバ両方で TCP Fast Open を使用できる。 TCP Fast Open の闇 しかし、数年前よりこの TCP Fast Open には一部のネットワークで奇妙な振る舞いをすることが知られている。
>
> <https://asnokaze.hatenablog.com>

### QUIC などの UDP をベースにした方法

QUIC も基本的には 3 way ハンドシェイクを行うが、接続確立と同時に暗号用の情報を送るというのが違い。

一度ハンドシェイクが確立した後であれば、 0-RTT という形で 2 回目以降の接続確立とデータ伝送を並行実施することで、効率化することができるようになっている。

[QUIC をゆっくり解説(4)：ハンドシェイク | IIJ Engineers Blog](https://eng-blog.iij.ad.jp/archives/10582)

[QUIC をゆっくり解説(5)：2 回目以降のハンドシェイクと 0-RTT | IIJ Engineers Blog](https://eng-blog.iij.ad.jp/archives/10620)
