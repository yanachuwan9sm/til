# Cookie

## What`s is Cookie?

(set-cookie を)送ったら次から(Cookie として）送り返してくるヤツ。
👉 ブラウザは Set-Cookie してきたサイトを覚えておき、そのサイトにアクセスするたびに Cookie ヘッダで自動で送り返す。
👉 いわゆる画面に表示される URL だけではなく、そのサブリソース（image/JavaScript/iFlame)にも適用される。

一意な値を Cookie として付与すれば、ユーザが 区別 できるが、この時点では 識別 はしてない

最近の EC サービスは、ログインしていなくてもショッピングカートに追加でき、決済直前で認証を挟む実装が多いが、これは先にカートのための 区別 を行い、あとから 識別 していることになる。

> Cookie とは必ずしも認証結果というわけではなく、ユーザ同士が 区別 できれば良いだけのユースケースもあるというのが、 Cookie の使い方を考える上で非常に大事なことだ。
> 3PCA 2 日目: Cookie による区別と識別 | blog.jxck.io

## Cookie の主なユースケース

### クッキーを使ったセッション管理

（HTTP はその時の要求に対しての応答を返すだけで、前回の状態を保持できないステートレスなプロトコルであるため）クライアントとサーバーの間のセッション状態を保持する方式として Cookie & Session を用いる必要がある。

そのセッション情報（セッション ID）をどこ（セッションストレージ）に保存するかで大きく三種類ある。
👉 クッキーにする？Redis にする？サーバーのメモリにする？

**● CookieStore（クッキー方式）**

セッション情報を全て暗号化してクライアントの Cookie に保存する。（今回のトピックにあたるもの）
クライアントで完結するため、セッションストレージとしてのサーバーは不要
クライアントの Cookie に保存されているため、データベースへのアクセスが不要（処理が高速）
データサイズの制限がある。（Cookie は最大で 4kB までの情報しか保存できない。）
すべての情報をクッキーに入れるので、クッキーの情報がコピーされて盗まれたら、サーバーとのセッションも偽装されてしまう。

**● Redis（インメモリ方式）**

Redis や他の Key-Value 型のデータベースにセッション ID とセッション情報を保存し、クライアントの Cookie にはセッション ID のみを保存しする（リクエストで受け取ったセッション ID を使用して Redis から情報を取得）
処理が高速であり、情報漏洩のリスクが低い
容量制限がない & サーバー側でセッションクリアができる。
リクエストごとに DB アクセスの I/O コストが発生 ＆ メモリを使い果たすと書き込みが全てエラーになる。

**● DB（データベース方式）**

インメモリ方式と同様にセッション ID とセッション情報を保存しますが、データベースに保存する。
クライアントの Cookie にはセッション ID のみを保存します。
クライアントからのリクエストで受け取ったセッション ID を使用してデータベースから情報を取得します。
インメモリやクッキーと比べてデータの取得が遅くなる場合がある。
セッションの期限付き発行やセッションの永続性に他のソリューションと比較した場合に長けている。
署名付きクッキーによるセッションデータの保存
署名付き URL と 署名付きクッキー の違い あんまり理解してないかもしれない。

### 署名付きクッキー

https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-signed-cookies.html#private-content-how-signed-cookies-work
https://zenn.dev/tera_ny/articles/034c2cca6674b3

### セッション認証とトークン認証について

## 3rd Party Cookie

3rd party cookie とは？については以下の記事がめちゃめちゃ分かりやすい。
<https://blog.jxck.io/entries/2023-12-04/3pca-3rd-party-cookie.html>

3rd party Cookie 廃止するね。これで簡単な確認はできそう。
